<!-- Replace the <script> section in your HTML with this: -->

<script>
  const videoInput = document.getElementById('videoInput');
  const downloadBtn = document.getElementById('downloadBtn');
  const progress = document.getElementById('progress');
  const faceCount = document.getElementById('faceCount');
  const loader = document.getElementById('loader');
  const blurStrength = document.getElementById('blurStrength');
  const blurValue = document.getElementById('blurValue');
  const progressBar = document.getElementById('progressBar');
  const outputCanvas = document.createElement('canvas');
  outputCanvas.style.display = 'none';
  document.body.appendChild(outputCanvas);

  let model;
  let processing = false;
  let currentBlur = 25;
  let lastPredictions = [];

  // Load Blazeface model
  async function loadModel() {
    loader.style.display = 'block';
    try {
      model = await blazeface.load({ maxFaces: 20 });
      console.log("Blazeface model loaded successfully!");
      loader.style.display = 'none';
    } catch (error) {
      console.error("Model load failed:", error);
      alert("Error loading model. Please try again.");
      loader.style.display = 'none';
    }
  }
  loadModel();

  // Blur strength update
  blurStrength.addEventListener('input', () => {
    currentBlur = blurStrength.value;
    blurValue.textContent = currentBlur;
  });

  // Fix upload trigger
  videoInput.addEventListener('click', () => {
    console.log("File input clicked!");
  });

  videoInput.addEventListener('change', async (event) => {
    console.log("File input changed!", event.target.files);
    if (!model) {
      alert("Model not loaded yet!");
      return;
    }

    const videoFile = event.target.files[0];
    if (!videoFile) {
      console.log("No file selected!");
      return;
    }

    loader.style.display = 'block';
    downloadBtn.disabled = true;
    console.log("Video selected:", videoFile.name, videoFile.size);

    const videoUrl = URL.createObjectURL(videoFile);
    const videoElement = document.createElement('video');
    videoElement.src = videoUrl;
    videoElement.muted = true; // Ensure muted for local files
    videoElement.preload = 'auto'; // Preload to help with local files

    await new Promise((resolve, reject) => {
      videoElement.onloadedmetadata = () => {
        console.log("Video metadata loaded:", videoElement.videoWidth, videoElement.videoHeight, videoElement.duration);
        resolve();
      };
      videoElement.onerror = () => {
        console.error("Error loading video metadata");
        reject(new Error("Failed to load video metadata"));
      };
    }).catch(error => {
      console.error("Metadata loading error:", error);
      alert("Failed to load video. Please ensure itâ€™s a valid video file and try again.");
      loader.style.display = 'none';
      return;
    });

    const targetWidth = videoElement.videoWidth;
    const targetHeight = videoElement.videoHeight;
    const duration = videoElement.duration;
    const frameRate = 30;
    outputCanvas.width = targetWidth;
    outputCanvas.height = targetHeight;

    const ctx = outputCanvas.getContext('2d', { alpha: false });
    const stream = outputCanvas.captureStream(frameRate);

    // Add audio tracks
    const audioTracks = videoElement.captureStream().getAudioTracks();
    if (audioTracks.length > 0) {
      audioTracks.forEach(track => {
        console.log("Adding audio track:", track);
        stream.addTrack(track);
      });
    } else {
      console.warn("No audio tracks found in input video.");
    }

    const recorder = new MediaRecorder(stream, {
      mimeType: 'video/webm;codecs=vp9,opus',
      videoBitsPerSecond: 3000000, // 3 Mbps
      audioBitsPerSecond: 96000   // 96 kbps
    });
    const chunks = [];
    recorder.ondataavailable = e => {
      console.log("Chunk received:", e.data.size);
      chunks.push(e.data);
    };
    recorder.onstop = () => {
      console.log("Recording stopped, total chunks:", chunks.length);
      const blob = new Blob(chunks, { type: 'video/webm' });
      finalizeDownload(blob);
      loader.style.display = 'none';
    };
    recorder.onerror = (e) => {
      console.error("Recorder error:", e);
      alert("Processing failed. Please try again.");
      loader.style.display = 'none';
    };
    recorder.onstart = () => console.log("Recorder started!");

    recorder.start(50);
    videoElement.playbackRate = 2;
    try {
      await videoElement.play();
      console.log("Video playback started!");
    } catch (