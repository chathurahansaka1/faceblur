<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Face Blur</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>
    <style>
        body { margin: 0; padding: 20px; background: #1a1a1a; color: white; }
        canvas { display: none; }
        video { width: 100%; max-width: 600px; }
        .controls { margin: 20px 0; }
        button { padding: 10px 20px; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <video id="inputVideo" controls></video>
        <canvas id="outputCanvas"></canvas>
        
        <div class="controls">
            <input type="file" id="videoInput" accept="video/*">
            <button id="processBtn" disabled>Process Video</button>
            <button id="downloadBtn" disabled>Download</button>
        </div>
    </div>

<script>
const videoElement = document.getElementById('inputVideo');
const canvasElement = document.getElementById('outputCanvas');
const ctx = canvasElement.getContext('2d');
let mediaRecorder;
let chunks = [];

// Initialize MediaPipe Face Detection
const faceDetection = new FaceDetection({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`
});

faceDetection.setOptions({
    model: 'short',
    minDetectionConfidence: 0.5
});

faceDetection.onResults(processResults);

// File input handler
document.getElementById('videoInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    videoElement.src = URL.createObjectURL(file);
    videoElement.onloadedmetadata = () => {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        document.getElementById('processBtn').disabled = false;
    };
});

// Process video frames
async function processVideo() {
    videoElement.pause();
    const stream = canvasElement.captureStream(30);
    mediaRecorder = new MediaRecorder(stream);
    
    mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
    mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        document.getElementById('downloadBtn').disabled = false;
        document.getElementById('downloadBtn').onclick = () => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'blurred-video.webm';
            a.click();
        };
    };

    mediaRecorder.start();
    
    while (videoElement.currentTime < videoElement.duration) {
        await processFrame();
        await new Promise(r => setTimeout(r, 0));
    }
    
    mediaRecorder.stop();
}

// Process individual frame
async function processFrame() {
    ctx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
    await faceDetection.send({ image: canvasElement });
}

// Handle detection results
function processResults(results) {
    if (!results.detections) return;

    // Apply blur to detected faces
    results.detections.forEach(detection => {
        const { boundingBox } = detection;
        const x = boundingBox.xCenter * canvasElement.width - boundingBox.width * canvasElement.width / 2;
        const y = boundingBox.yCenter * canvasElement.height - boundingBox.height * canvasElement.height / 2;
        const width = boundingBox.width * canvasElement.width;
        const height = boundingBox.height * canvasElement.height;

        // Fast blur using CSS filter
        ctx.filter = 'blur(20px)';
        ctx.drawImage(
            canvasElement,
            x, y, width, height,
            x, y, width, height
        );
        ctx.filter = 'none';
    });
}

// Button handlers
document.getElementById('processBtn').addEventListener('click', processVideo);
</script>
</body>
</html>